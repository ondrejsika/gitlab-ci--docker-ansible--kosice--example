stages:
  - build
  - build_docker
  - test

.build_template: &build_template
  stage: build
  artifacts:
    paths:
      - server

build:
  <<: *build_template
  image: golang
  script:
    - go build server.go
  only:
    changes:
      - server.go

get_build_artifacts:
  <<: *build_template
  image: ondrejsika/ci
  script:
    - curl -fsSL  https://gitlab-kosice.do.xsika.cz/$CI_PROJECT_PATH/-/jobs/artifacts/$CI_COMMIT_REF_NAME/download?job=build > a.zip
    - unzip a.zip
  only:
    changes:
      - Dockerfile
  except:
    changes:
      - server.go

build_docker:
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker build -t $CI_REGISTRY_IMAGE .
    - docker push $CI_REGISTRY_IMAGE
  only:
    changes:
      - server.go
      - Dockerfile

test:
  stage: test
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker pull $CI_REGISTRY_IMAGE
    - docker run -d --name server-$CI_JOB_ID $CI_REGISTRY_IMAGE
    - docker run --link server-$CI_JOB_ID:server ondrejsika/curl -fsSL -i http://server
  after_script:
    - docker rm -f server-$CI_JOB_ID